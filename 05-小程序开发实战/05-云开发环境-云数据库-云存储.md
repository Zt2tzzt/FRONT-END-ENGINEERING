# 一个完整的项目，包含多端

理解图解。

<img src="NodeAssets/一个完整的项目.jpg" style="zoom:80%;" />

# 传统模式开发的成本考虑

- 如果一个小公司或个人只是想开发一个小程序推广自己的产品或者实现某个想法，按照传统的开发模式，我们需要考虑哪些东西呢？
  - 成本角度：维护服务器成本，并且需要考虑并发量大后服务器的扩展。
  - 技术研发：对于单纯会前端的人来说，学习后端相关的技术，成本较高。

<img src="NodeAssets/小程序开发成本.jpg" alt="小程序开发成本" style="zoom:100%;" />

# 云开发的介绍

## 云开发的定位

* 个人的项目或者想法, 不想开发服务器, 直接使用云开发
* 某些公司的小程序项目也是使用云开发(不多)
* 了解一些云开发中的思想, 比如服务器/数据库/存储, 有利于以后学习服务器相关的开发技术
  * MySQL/Node/上传文件

## 云开发和传统开发的对比

云开发的模式

<img src="NodeAssets/云开发的模式.jpg" alt="云开发的模式" style="zoom:80%;" />

云开发模式与传统开发模式对比

<img src="NodeAssets/云开发模式与传统开发模式对比.jpg" alt="云开发模式与传统开发模式对比" style="zoom:150%;" />

项目流程对比

<img src="NodeAssets/项目流程对比.jpg" alt="项目流程对比" style="zoom:80%;" />

# 云开发三大核心技术

云开发主要包含三大核心技术：

- 云数据库：
	- 提供在小程序端直接对数据库进行增删改查的能力；
	- 数据库是类似于 MongoDB 的文档存储的数据库，操作非常方便；
- 云存储：
	- 可以在小程序端直接上传、下载、删除文件；
	- 自带CDN，提高文件访问速度；
	- 可以获取临时链接，支持在小程序外访问；
- 云函数：
	- 提供了在服务器执行代码的能力，需要编写函数，上传到服务器；
	- 包含微信天然的私有鉴权；
	- 更大权限的操作数据库等；
	- 进行云调用、HTTP请求等操作；

# 创建一个云开发项目

在微信开发者工具中，创建小程序项目，后端服务选择【微信云开发】。

目录结构如下，miniprogram 为小程序项目的根目录。

<img src="NodeAssets/小程序云开发目录结构.jpg" alt="小程序云开发目录结构" style="zoom:100%;" />

# 云开发控制台

在微信开发者工具中，点击上方云开发，进入云开发控制台。

- 云开发控制台有以下模块：
	- 运营分析
	- 数据库（云数据库）
	- 存储（云存储）
	- 云函数
	- 云托管（本质上部署于云开发范畴，广告推广性质）
- 开通云开发
	- 设置 – 环境名称 – 创建环境

云开发的环境和配额：

- 什么是环境：
	- 一个环境对应一整套独立的云开发资源，包括数据库、存储空间、云函数等资源（相当于一个新的服务器）。
	- 各个环境是相互独立的，用户开通云开发后即创建了一个环境，默认可拥有最多两个环境。
	- 在实际开发中，建议每一个正式环境都搭配一个测试环境，所有功能先在测试环境测试完毕后再上到正式环境。
- 什么是配额：
	- 默认有一定的免费配额（已经改成了1个月免费）；
	- 后期可以根据自己的业务量选择对应的更高配额；
	- [官方文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/billing/quota.html)

# 云开发项目初始化

在小程序端开始使用云能力前，需先调用 `wx.cloud.init` 方法完成云能力初始

传入的两个参数

| 字段      | 数据类型         | 必填 | 默认值                       | 说明                                           |
| --------- | ---------------- | ---- | ---------------------------- | ---------------------------------------------- |
| env       | string \| object | 否   | 默认环境（第一个创建的环境） | API 调用的默认环境                             |
| traceUser | boolean          | 否   | false                        | 是否将用户访问，记录到用户管理中，在控制台可见 |

miniprogram\app.js

```js
App({
  onLaunch: function () {
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力');
    } else {
      wx.cloud.init({
        env: 'cloud1-8g4a3iira9235aea',
        traceUser: true,
      });
    }
  }
});

```

配置小程序项目根目录和云函数根目录

project.config.json

```json
{
  "miniprogramRoot": "miniprogram/",
  "cloudfunctionRoot": "cloudfunctions/",
}
```

# 云数据库

## 什么是云数据库

- JSON 数据库：

  - 云开发提供了一个文档型数据库，类似于 MongoDB，里面存放的是一条条 JSON 格式的对象；

  - 一个数据库可以包含多个集合，一个集合中包含多个 JSON 对象；

  - 理解关系型数据库和文档型数据库的区别。

    | 关系型          | 文档型            |
    | --------------- | ----------------- |
    | 数据库 database | 数据库 database   |
    | 表 table        | 集合 collection   |
    | 行 row          | 记录 record / doc |
    | 列 column       | 字段 field        |

- 提供方便的API调用：学习这些API即可；

- 提供了小程序端和服务器端（云函数）中调用的区分；

## 在云数据库中，手动添加数据

- 创建集合
- 创建一条数据（使用默认模式，或 JSON 模式）
- 添加字段
- 导入一组数据
  - 手动导入，使用 JSON 模式时，外层是一个个对象，中间不能有逗号。

## 在云数据库中，使用小程序添加数据。

- 插入成功后，会返回自动生成的 id。

- 获取是否添加成功的回调结果。
- 小程序添加的数据，有 openid 字段，用于记录那个用户添加的数据。

删除云数据库中的某一条数据。

> 写入一般指的是新增，修改，删除。

	- 什么是查询指令，在删除时使用查询指令。但删除时会报警告，小程序推荐使用云函数（server 端）来删除云数据库中的数据。



* 在云数据库中修改数据，两种方式。
	- 一次更新多条数据，使用查询指令。推荐在云函数（Server 端）中进行。
* 在云数据库中，查询数据的六种方式。
* 对斗鱼的数据做增删改查，案例理解。
	- 为集合中的记录添加索引，可以提高查找效率。数据库中通过 B 树数据结构进行查找。默认 _id, _openid 两字段已经建立了索引。
* 什么是云存储。
* 云存储的操作，上传文件，下载文件，获取临时文件。



